<%- include('../partials/header') %>
<h1><%= post ? '编辑文章' : '新建文章' %></h1>
<form method="post" action="<%= post ? '/admin/posts/' + post.id + '?_method=PUT' : '/admin/posts' %>" class="card">
  <input name="title" value="<%= post?.title || '' %>" placeholder="标题" required />
  <input name="slug" value="<%= post?.slug || '' %>" placeholder="Slug（可空）" />
  <textarea name="excerpt" placeholder="摘要"><%= post?.excerpt || '' %></textarea>

  <label>可视化编辑器（支持基础富文本）</label>
  <div id="editor" contenteditable="true" class="editor"><%- post?.content || '' %></div>
  <textarea id="contentField" name="content" style="display:none"><%= post?.content || '' %></textarea>

  <select name="status">
    <option value="draft" <%= post?.status === 'draft' ? 'selected' : '' %>>草稿</option>
    <option value="published" <%= post?.status === 'published' ? 'selected' : '' %>>发布</option>
    <option value="scheduled" <%= post?.status === 'scheduled' ? 'selected' : '' %>>定时发布</option>
  </select>

  <label>发布时间</label>
  <input type="datetime-local" name="publishedAt" value="<%= post?.publishedAt ? dayjs(post.publishedAt).format('YYYY-MM-DDTHH:mm') : '' %>" />

  <select name="categoryId" required>
    <% categories.forEach(c => { %>
      <option value="<%= c.id %>" <%= post?.CategoryId === c.id ? 'selected' : '' %>><%= c.name %></option>
    <% }) %>
  </select>

  <fieldset>
    <legend>标签</legend>
    <% tags.forEach(tag => { %>
      <label>
        <input type="checkbox" name="tags" value="<%= tag.id %>" <%= post?.Tags?.some(t => t.id === tag.id) ? 'checked' : '' %> />
        <%= tag.name %>
      </label>
    <% }) %>
  </fieldset>

  <button type="submit">保存</button>
</form>
<script>
  const form = document.querySelector('form');
  const editor = document.getElementById('editor');
  const contentField = document.getElementById('contentField');
  form.addEventListener('submit', () => {
    contentField.value = editor.innerHTML;
  });
</script>
<%- include('../partials/footer') %>
